<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="~{common::header}"></head>
<body>
<div class="container-xxl bg-white p-0 d-flex flex-column min-vh-100">
    <div th:replace="~{common::nav}"></div>

    <div class="container mt-4">
        <div class="row">
            <aside class="col-md-3 mb-3">
                <div class="border rounded p-2">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <strong>내 채팅방</strong>
                        <a class="small" th:href="@{/chat}">모두 보기</a>
                    </div>
                    <div id="roomList" class="list-group small" style="max-height: 420px; overflow-y: auto;"></div>
                </div>
            </aside>
            <main class="col-md-9">
        <div class="chat-header d-flex align-items-center gap-2 mb-3">
            <span class="h4 mb-0">채팅방 - </span>
            <span id="roomName" class="h4 mb-0" th:text="${chatRoomName}">Room Name</span>
            <button id="editRoomNameBtn" class="btn btn-sm btn-outline-secondary">이름 변경</button>
            <div id="editRoomNameBox" class="input-group input-group-sm" style="max-width: 360px; display:none;">
                <input type="text" id="roomNameInput" class="form-control" placeholder="새 방 이름"/>
                <button class="btn btn-primary" id="saveRoomNameBtn">저장</button>
                <button class="btn btn-outline-secondary" id="cancelRoomNameBtn">취소</button>
            </div>
        </div>

        <!-- 메시지 영역 -->
        <div class="chat-messages border rounded p-3 mb-3" id="chatBox" style="height: 420px; overflow-y:auto;">
            <!-- 초기 서버사이드 렌더링 -->
            <div th:if="${#lists.isEmpty(messages)}" class="text-muted">메시지가 여기에 표시됩니다.</div>

            <div th:each="m : ${messages}"
                 th:attr="data-mid=${m.id}"
                 th:class="${m.sender.userName == me} ? 'd-flex justify-content-end mb-2' : 'd-flex justify-content-start mb-2'">
                <div th:class="${m.sender.userName == me} ? 'bg-primary text-white p-2 rounded-3' : 'bg-light p-2 rounded-3'"
                     style="max-width: 75%;">
                    <div class="small text-muted mb-1" th:text="${m.sender.userName}">sender</div>
                    <div th:text="${m.content}">content</div>
                    <div class="small text-muted mt-1 text-end"
                         th:text="${#temporals.format(m.createdAt, 'yyyy-MM-dd HH:mm')}">time</div>
                </div>
            </div>
        </div>

        <!-- 입력 폼 -->
        <div class="chat-input">
            <form th:action="@{/chat/send}" method="post" id="sendForm">
                <input type="hidden" name="roomId" th:value="${roomId}">
                <!-- Spring Security CSRF (보안 설정에서 활성화된 경우에만 렌더링) -->
                <th:block th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </th:block>

                <div class="input-group">
                    <textarea name="message" id="messageInput" class="form-control" rows="2"
                              placeholder="메시지를 입력하세요..." required></textarea>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        <span class="ms-1">보내기</span>
                    </button>
                </div>
            </form>
        </div>
            </main>
        </div>
    </div>

    <footer th:replace="~{common::footer}"></footer>
    <div th:replace="~{common::script}"></div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const roomId = /*[[${roomId}]]*/ 0;
    const me = /*[[${me}]]*/ '';
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('messageInput');
    const roomList = document.getElementById('roomList');

    function getLastId() {
        const items = chatBox.querySelectorAll('[data-mid]');
        if (items.length === 0) return 0;
        return Number(items[items.length - 1].getAttribute('data-mid')) || 0;
    }
    let lastId = getLastId();

    function appendMessage(m) {
        const wrapper = document.createElement('div');
        wrapper.className = (m.sender === me) ? 'd-flex justify-content-end mb-2'
            : 'd-flex justify-content-start mb-2';
        wrapper.setAttribute('data-mid', m.id);

        const bubble = document.createElement('div');
        bubble.className = (m.sender === me) ? 'bg-primary text-white p-2 rounded-3'
            : 'bg-light p-2 rounded-3';
        bubble.style.maxWidth = '75%';

        const meta = document.createElement('div');
        meta.className = 'small text-muted mb-1';
        meta.textContent = m.sender;

        const text = document.createElement('div');
        text.textContent = m.content;

        const time = document.createElement('div');
        time.className = 'small text-muted mt-1 text-end';
        time.textContent = m.createdAt || '';

        bubble.appendChild(meta);
        bubble.appendChild(text);
        bubble.appendChild(time);
        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    scrollToBottom();

    // 내 채팅방 목록 불러오기
    async function loadMyRooms() {
        if (!roomList) return;
        try {
            const res = await fetch('/chat/rooms', { cache: 'no-store' });
            if (!res.ok) throw new Error('network');
            const rooms = await res.json(); // [{id, roomName}]
            if (!Array.isArray(rooms) || rooms.length === 0) {
                roomList.innerHTML = '<div class="list-group-item text-muted">채팅방 없음</div>';
                return;
            }
            const frag = document.createDocumentFragment();
            rooms.forEach(r => {
                const a = document.createElement('a');
                a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                a.href = `/chat/room/${r.id}`;
                a.textContent = r.roomName;
                if (Number(r.id) === Number(roomId)) {
                    a.classList.add('active');
                }
                frag.appendChild(a);
            });
            roomList.innerHTML = '';
            roomList.appendChild(frag);
        } catch (e) {
            roomList.innerHTML = '<div class="list-group-item text-danger">목록 로드 실패</div>';
        }
    }
    loadMyRooms();

    async function poll() {
        try {
            const res = await fetch(`/chat/room/${roomId}/messages?afterId=${lastId}`, { cache: 'no-store' });
            if (!res.ok) throw new Error('network');
            const data = await res.json(); // [{id, sender, content, createdAt}]
            if (Array.isArray(data) && data.length > 0) {
                const atBottom = Math.abs(chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 8;
                data.forEach(m => {
                    appendMessage(m);
                    lastId = Math.max(lastId, Number(m.id) || 0);
                });
                if (atBottom) scrollToBottom();
            }
        } catch (e) {
        } finally {
            setTimeout(poll, 2000);
        }
    }
    // --- STOMP 클라이언트 ---
    ;(function(){
        const sock = new SockJS('/ws');
        const stomp = Stomp.over(sock);
        stomp.debug = null;
        stomp.connect({}, () => {
            stomp.subscribe(`/topic/chat.${roomId}`, (frame) => {
                try {
                    const m = JSON.parse(frame.body);
                    appendMessage(m);
                    scrollToBottom();
                } catch {}
            });
        });

        function doSend() {
            const content = msgInput.value.trim();
            if (!content) return;
            stomp.send('/app/chat.send', {}, JSON.stringify({ roomId, message: content }));
            msgInput.value = '';
        }

        document.getElementById('sendForm').addEventListener('submit', (e) => {
            e.preventDefault();
            doSend();
        });

        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                doSend();
            }
        });
    })();

    // --- Room name inline edit ---
    (function(){
        const btn = document.getElementById('editRoomNameBtn');
        const box = document.getElementById('editRoomNameBox');
        const nameEl = document.getElementById('roomName');
        const input = document.getElementById('roomNameInput');
        const save = document.getElementById('saveRoomNameBtn');
        const cancel = document.getElementById('cancelRoomNameBtn');

        if(!btn) return;

        btn.addEventListener('click', () => {
            input.value = nameEl.textContent.trim();
            box.style.display = '';
            btn.style.display = 'none';
            input.focus();
        });

        cancel.addEventListener('click', () => {
            box.style.display = 'none';
            btn.style.display = '';
        });

        save.addEventListener('click', async () => {
            const newName = input.value.trim();
            if(!newName) return;
            try {
                const res = await fetch(`/chat/room/${roomId}/name`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ roomName: newName })
                });
                const data = await res.json();
                if(data.ok) {
                    nameEl.textContent = data.roomName;
                    box.style.display = 'none';
                    btn.style.display = '';
                } else {
                    alert(data.message || '이름 변경 실패');
                }
            } catch(e) { alert('네트워크 오류'); }
        });
    })();
    /*]]>*/
</script>
</body>
</html>
