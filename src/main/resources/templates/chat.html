<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="~{common::header}"></head>
<body>
<div class="container-xxl bg-white p-0 d-flex flex-column min-vh-100">
    <div th:replace="~{common::nav}"></div>

    <div class="container mt-4">
        <div class="chat-header h4 mb-3">
            채팅방 - <span th:text="${chatRoomName}">Room Name</span>
        </div>

        <!-- 메시지 영역 -->
        <div class="chat-messages border rounded p-3 mb-3" id="chatBox" style="height: 420px; overflow-y:auto;">
            <!-- 초기 서버사이드 렌더링 -->
            <div th:if="${#lists.isEmpty(messages)}" class="text-muted">메시지가 여기에 표시됩니다.</div>

            <div th:each="m : ${messages}"
                 th:attr="data-mid=${m.id}"
                 th:class="${m.sender.userName == me} ? 'd-flex justify-content-end mb-2' : 'd-flex justify-content-start mb-2'">
                <div th:class="${m.sender.userName == me} ? 'bg-primary text-white p-2 rounded-3' : 'bg-light p-2 rounded-3'"
                     style="max-width: 75%;">
                    <div class="small text-muted mb-1" th:text="${m.sender.userName}">sender</div>
                    <div th:text="${m.content}">content</div>
                    <div class="small text-muted mt-1 text-end"
                         th:text="${#temporals.format(m.createdAt, 'yyyy-MM-dd HH:mm')}">time</div>
                </div>
            </div>
        </div>

        <!-- 입력 폼 -->
        <div class="chat-input">
            <form th:action="@{/chat/send}" method="post" id="sendForm">
                <input type="hidden" name="roomId" th:value="${roomId}">
                <!-- Spring Security CSRF (보안 설정에서 활성화된 경우에만 렌더링) -->
                <th:block th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                </th:block>

                <div class="input-group">
                    <textarea name="message" id="messageInput" class="form-control" rows="2"
                              placeholder="메시지를 입력하세요..." required></textarea>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        <span class="ms-1">보내기</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer th:replace="~{common::footer}"></footer>
    <div th:replace="~{common::script}"></div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const roomId = /*[[${roomId}]]*/ 0;
    const me = /*[[${me}]]*/ '';
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('messageInput');

    function getLastId() {
        const items = chatBox.querySelectorAll('[data-mid]');
        if (items.length === 0) return 0;
        return Number(items[items.length - 1].getAttribute('data-mid')) || 0;
    }
    let lastId = getLastId();

    function appendMessage(m) {
        const wrapper = document.createElement('div');
        wrapper.className = (m.sender === me) ? 'd-flex justify-content-end mb-2'
            : 'd-flex justify-content-start mb-2';
        wrapper.setAttribute('data-mid', m.id);

        const bubble = document.createElement('div');
        bubble.className = (m.sender === me) ? 'bg-primary text-white p-2 rounded-3'
            : 'bg-light p-2 rounded-3';
        bubble.style.maxWidth = '75%';

        const meta = document.createElement('div');
        meta.className = 'small text-muted mb-1';
        meta.textContent = m.sender;

        const text = document.createElement('div');
        text.textContent = m.content;

        const time = document.createElement('div');
        time.className = 'small text-muted mt-1 text-end';
        time.textContent = m.createdAt || '';

        bubble.appendChild(meta);
        bubble.appendChild(text);
        bubble.appendChild(time);
        wrapper.appendChild(bubble);
        chatBox.appendChild(wrapper);
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    scrollToBottom();

    async function poll() {
        try {
            const res = await fetch(`/chat/room/${roomId}/messages?afterId=${lastId}`, { cache: 'no-store' });
            if (!res.ok) throw new Error('network');
            const data = await res.json(); // [{id, sender, content, createdAt}]
            if (Array.isArray(data) && data.length > 0) {
                const atBottom = Math.abs(chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 8;
                data.forEach(m => {
                    appendMessage(m);
                    lastId = Math.max(lastId, Number(m.id) || 0);
                });
                if (atBottom) scrollToBottom();
            }
        } catch (e) {
        } finally {
            setTimeout(poll, 2000);
        }
    }
    setTimeout(poll, 2000);

    document.getElementById('sendForm').addEventListener('submit', () => {
        msgInput.value = msgInput.value.trim();
    });
    /*]]>*/
</script>
</body>
</html>
